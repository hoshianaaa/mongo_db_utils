#!/bin/bash
# MongoDB管理ツール一括インストール (install_mongodb_tools.sh)

# 実行ログを出力する関数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "MongoDB管理ツールをインストールします..."

# 必要なパッケージをインストール
log "必要なパッケージをインストールしています..."
sudo apt update
sudo apt install -y curl wget gnupg2 software-properties-common apt-transport-https ca-certificates

# Nodejsをインストール（複数のWeb UIが必要とするため）
if ! command -v node &> /dev/null; then
    log "Node.jsをインストールしています..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt install -y nodejs
fi

# 1. MongoDB Compassをインストール
log "MongoDB Compassをインストールしています..."
wget https://downloads.mongodb.com/compass/mongodb-compass_1.40.4_amd64.deb -O mongodb-compass.deb
sudo apt install -y ./mongodb-compass.deb
rm ./mongodb-compass.deb

# 2. Mongo Expressをインストール
log "Mongo Expressをインストールしています..."
sudo npm install -g mongo-express

# 設定ファイルを作成
mkdir -p ~/mongo-express-config
cat > ~/mongo-express-config/config.js << 'EOL'
'use strict';

const config = {
    mongodb: {
        server: 'localhost',
        port: 27017,
        autoReconnect: true,
        poolSize: 4,
        admin: true,
        auth: false,
        username: '',
        password: ''
    },
    site: {
        baseUrl: '/',
        host: '0.0.0.0',
        port: 8081,
        cookieSecret: 'mongo-express-secret',
        sessionSecret: 'mongo-express-session-secret',
        cookieKeyName: 'mongo-express'
    },
    useBasicAuth: false,
    basicAuth: {
        username: '',
        password: ''
    },
    options: {
        editMode: 'modal',
        readOnly: false
    }
};

module.exports = config;
EOL

# 3. MongoDBデータベースツールをインストール
log "MongoDB Database Toolsをインストールしています..."
sudo apt install -y mongodb-database-tools

# 4. Studio 3T Freeをインストール（旧Robo 3T）
log "Studio 3T Freeをインストールしています..."
wget https://download.studio3t.com/studio-3t/linux/2023.7.0/studio-3t-linux-x64.tar.gz -O studio-3t.tar.gz
mkdir -p ~/studio-3t
tar -xzf studio-3t.tar.gz -C ~/studio-3t --strip-components=1
rm studio-3t.tar.gz

# デスクトップショートカットを作成
cat > ~/.local/share/applications/studio-3t.desktop << EOL
[Desktop Entry]
Name=Studio 3T
Comment=MongoDB GUI
Exec=${HOME}/studio-3t/studio-3t.sh
Icon=${HOME}/studio-3t/icon.png
Terminal=false
Type=Application
Categories=Development;
EOL

# 起動スクリプトを作成
cat > ~/mongodb_tools.sh << 'EOL'
#!/bin/bash

# 使用方法を表示
show_usage() {
    echo "使用方法: $0 [compass|express|studio3t|help]"
    echo ""
    echo "オプション:"
    echo "  compass  - MongoDB Compassを起動します"
    echo "  express  - Mongo Expressを起動します"
    echo "  studio3t - Studio 3Tを起動します"
    echo "  help     - このヘルプメッセージを表示します"
}

case "$1" in
    compass)
        echo "MongoDB Compassを起動しています..."
        mongodb-compass &
        ;;
    express)
        echo "Mongo Expressを起動しています..."
        NODE_ENV=development mongo-express -c ~/mongo-express-config/config.js
        ;;
    studio3t)
        echo "Studio 3Tを起動しています..."
        ~/studio-3t/studio-3t.sh &
        ;;
    help)
        show_usage
        ;;
    *)
        show_usage
        exit 1
        ;;
esac

exit 0
EOL

chmod +x ~/mongodb_tools.sh

log "MongoDB管理ツールのインストールが完了しました。"
log ""
log "以下のコマンドで各ツールを起動できます："
log "  MongoDB Compass: ~/mongodb_tools.sh compass"
log "  Mongo Express:   ~/mongodb_tools.sh express"
log "  Studio 3T Free:  ~/mongodb_tools.sh studio3t"
log ""
log "ブラウザアクセス:"
log "  Mongo Express:   http://localhost:8081"
log ""
log "または、アプリケーションメニューから MongoDB Compass と Studio 3T を起動できます。"
